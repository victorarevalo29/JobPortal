import { asyncHandler } from '../utils/asyncHandler.js'
import { sendCreated, sendSuccess } from '../utils/response.js'
import { createJob, deleteJobById, getJobById, listJobs, updateJobById } from '../services/jobService.js'
import { getUserById } from '../services/userService.js'
import { AppError } from '../utils/AppError.js'
import { verifyToken } from '../utils/token.js'
import { isTokenBlacklisted } from '../services/tokenService.js'

const resolveEmployerCompany = async (userId) => {
  const user = await getUserById(userId)
  const companyId = user?.company?.id || user?.company?._id?.toString()
  if (!companyId) {
    throw new AppError('Registra tu empresa antes de publicar vacantes', 400)
  }
  return companyId
}

const decodeUserFromRequest = async (req) => {
  if (req.user) return req.user

  const header = req.headers.authorization
  if (!header?.startsWith('Bearer ')) return null

  try {
    const token = header.split(' ')[1]
    const payload = verifyToken(token)
    const blacklisted = await isTokenBlacklisted(payload.jti)
    if (blacklisted) return null
    req.user = payload
    return payload
  } catch (error) {
    return null
  }
}

const resolveEmployerCompanyFilter = async (req) => {
  const userPayload = await decodeUserFromRequest(req)
  if (!userPayload) return { type: 'public' }

  if (userPayload.role !== 'employer') {
    return { type: 'user' }
  }

  const employer = await getUserById(userPayload.id)
  const companyId = employer?.company?._id || employer?.company?.id
  if (!companyId) {
    return { type: 'employer', companyId: null }
  }

  return { type: 'employer', companyId: companyId.toString() }
}

/**
 * @route POST /api/jobs
 * @description Crea una vacante vinculada a una empresa.
 */
export const createJobController = asyncHandler(async (req, res) => {
  const companyId = await resolveEmployerCompany(req.user.id)
  const job = await createJob({ ...req.body, company: companyId })
  return sendCreated(res, { message: 'Empleo creado', data: job })
})

/**
 * @route GET /api/jobs
 * @description Lista empleos con filtros por estado y empresa.
 */
export const listJobsController = asyncHandler(async (req, res) => {
  const employerScope = await resolveEmployerCompanyFilter(req)

  if (employerScope.type === 'employer' && employerScope.companyId === null) {
    return sendSuccess(res, { data: [] })
  }

  const filters = { ...req.query }
  if (employerScope.type === 'employer' && employerScope.companyId) {
    filters.company = employerScope.companyId
  }

  const jobs = await listJobs(filters)
  return sendSuccess(res, { data: jobs })
})

/**
 * @route GET /api/jobs/:id
 * @description Obtiene detalles completos de una vacante.
 */
export const getJobController = asyncHandler(async (req, res) => {
  const job = await getJobById(req.params.id)
  return sendSuccess(res, { data: job })
})

/**
 * @route PATCH /api/jobs/:id
 * @description Actualiza una vacante existente.
 */
export const updateJobController = asyncHandler(async (req, res) => {
  const companyId = await resolveEmployerCompany(req.user.id)
  const job = await updateJobById(req.params.id, { ...req.body, company: companyId }, companyId)
  return sendSuccess(res, { message: 'Empleo actualizado', data: job })
})

/**
 * @route DELETE /api/jobs/:id
 * @description Elimina una vacante.
 */
export const deleteJobController = asyncHandler(async (req, res) => {
  const companyId = await resolveEmployerCompany(req.user.id)
  await deleteJobById(req.params.id, companyId)
  return sendSuccess(res, { message: 'Empleo eliminado' })
})
